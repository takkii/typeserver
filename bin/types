#!/usr/bin/env node

import http from 'http';

const mask = process.argv[2];
const port = process.env.PORT || mask;
const obj = {};
const server = http.createServer(function (req, res) {
    let data;
    const remoteAddress = req.connection.remoteAddress;
    const header = {'Connection': 'close', 'Content-Length': 0};
    const key = req.url;
    if (req.method === 'POST') {
        if (obj[key]) {
            res.writeHead(403, header);
            res.end();
        } else {
            data = '';
            req.on('data', function (chunk) {
                data += chunk;
            })
            req.on('end', function () {
                try {
                    obj[key] = JSON.parse(data);
                    res.writeHead(200, header);
                    console.log('POST', key, obj[key], 'from ' + remoteAddress);
                } catch (e) {
                    res.writeHead(400, e.message, header);
                }
                res.end();
            });
        }
    } else if (req.method === 'GET') {
        if (obj[key]) {
            let json = JSON.stringify(obj[key]);
            res.writeHead(200, {
                'Content-Length': Buffer.byteLength(json),
                'Content-Type': 'application/json',
                'Connection': 'close'
            });
            res.write(json);
            console.log('GET', key, 'from ' + remoteAddress);
        } else {
            res.writeHead(404, header);
        }
        res.end();
    } else if (req.method === 'PUT') {
        if (obj[key]) {
            data = '';
            req.on('data', function (chunk) {
                data += chunk;
            });
            req.on('end', function () {
                try {
                    obj[key] = JSON.parse(data);
                    res.writeHead(200, header)
                    console.log('PUT', key, obj[key], 'from ' + remoteAddress);
                } catch (e) {
                    res.writeHead(400, e.message, header);
                }
                res.end();
            });
        } else {
            res.writeHead(403, header);
            res.end();
        }
    } else if (req.method === 'DELETE') {
        if (obj[key]) {
            delete obj[key];
            res.writeHead(200, header);
            console.log('DELETE', key, obj[key], 'from ' + remoteAddress);
        } else {
            res.writeHead(404, header);
        }
        res.end();
    }
    req.setTimeout(5000);

    req.on('timeout', function () {
        console.log('request timed out');
        req.abort()
    });

    req.on('error', function (err) {
        console.log('Error: ' + err.code + ', ' + err.message);
    });
});

server.on('error', function (e) {
    console.log('Server Error', e.message);
});

server.on('clientError', function (e) {
    console.log('Client Error', e.message);
})

server.listen(port, function () {
    console.log('listening on ' + port);
});
